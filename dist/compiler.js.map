{"version":3,"sources":["src/compiler.js"],"names":[],"mappings":"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","file":"src/compiler.js","sourcesContent":["const STATES = {\n  OUTER_SPACE: 'OUTER_SPACE',\n  HTML_TAG: 'HTML_TAG',\n  HTML_BODY: 'HTML_BODY',\n  HTML_ATTRIBUTE: 'HTML_ATTRIBUTE',\n  TORNADO_TAG: 'TORNADO_TAG',\n  TORNADO_BODY: 'TORNADO_BODY'\n};\nlet elIndex = -1;\nlet compiler = {\n  compile(ast, name) {\n    this.context = {\n      tornadoBodiesIndex: 0,\n      htmlBodiesIndexes: [],\n      htmlBodiesCount: -1,\n      refCount: 0,\n      blocks: {},\n      state: STATES.OUTER_SPACE\n    };\n    this.fragments = `f${this.context.tornadoBodiesIndex}: function() {\n      var frag = document.createDocumentFragment();\n      var cache = {frag: frag}\\n`;\n    this.renderers = `r${this.context.tornadoBodiesIndex}: function(c) {\n      var root = frags.frag${this.context.tornadoBodiesIndex} || this.f${this.context.tornadoBodiesIndex}();\\n`;\n    this.walk(ast);\n    return `(function(){\n  \"use strict\";\n  var frags = {},\n  t = {\n    ${this.fragments}\n    ${this.renderers}\n    render: null\n  };\n  t.render = t.r0;\n  td.register(\"${name}\", t);\n  return t;\n})();`;\n  },\n  step(node) {\n    if (node[0] && this[node[0]]) {\n      return this[node[0]](node);\n    }\n  },\n  walk(nodes = []) {\n    nodes.forEach((n) => this.step(n));\n    this.fragments = `${this.fragments}      return cache;\n    },`;\n    this.renderers = `${this.renderers}      return root.frag;\\n    },`;\n  },\n  /**\n   * Walk through the attributes of an HTML element\n   */\n  walkAttrs(items = []) {\n    let res = [];\n    items.forEach((item) => {\n      res.push(this.step(item));\n    });\n    return res.join('+');\n  },\n  /**\n   * Walk through the contents of an HTML element\n   */\n  walkContents(nodes = []) {\n    var indexes = this.context.htmlBodiesIndexes;\n    nodes.forEach((n) => {\n      this.step(n);\n      indexes[indexes.length-1]++;\n    });\n  },\n  buildElementAttributes(attributes = []) {\n    let attrs = '';\n    let previousState = this.context.state;\n    let refCount = this.context.refCount;\n    this.context.state = STATES.HTML_ATTRIBUTE;\n    attributes.forEach((attr) => {\n      let hasRef = attr.value.some(function(val) {\n        return val[0] === 'TORNADO_REFERENCE';\n      });\n      if (hasRef) {\n        this.renderers = `${this.renderers}      root.ref${refCount}.setAttribute('${attr.attrName}', ${this.walkAttrs(attr.value)});\\n`;\n      } else {\n        this.fragments = `${this.fragments}      el${this.context.htmlBodiesCount}.setAttribute('${attr.attrName}', ${this.walkAttrs(attr.value)});\\n`;\n      }\n    });\n    this.context.state = previousState;\n    return attrs;\n  },\n  getElContainerName() {\n    let count = this.context.htmlBodiesCount;\n    if (this.context.state === STATES.OUTER_SPACE || count === -1) {\n      return 'frag';\n    } else {\n      return `el${count}`;\n    }\n  },\n  TORNADO_BODY(node) {\n    this.context.nextTdBody = node[1].body;\n    return '';\n  },\n  TORNADO_REFERENCE(node) {\n    let indexes = this.context.htmlBodiesIndexes;\n    let idx = indexes[indexes.length - 1]++;\n    let refCount = this.context.refCount++;\n    let containerName = this.getElContainerName();\n    if (this.context.state === STATES.HTML_BODY) {\n      this.fragments = `${this.fragments}      cache.ref${refCount} = ${containerName};\n      ${this.getElContainerName()}.appendChild(document.createComment(''));\\n`;\n      this.renderers = `${this.renderers}      root.ref${refCount}.replaceChildAtIdx(${idx}, document.createTextNode(td.get(c, ${JSON.stringify(node[1].key)})));\\n`;\n    } else if (this.context.state === STATES.HTML_ATTRIBUTE) {\n      this.fragments = `${this.fragments}      cache.ref${refCount} = ${containerName};\\n`;\n      return `td.get(c, ${JSON.stringify(node[1].key)})`;\n    }\n  },\n  HTML_ELEMENT(node) {\n    let nodeInfo = node[1].tag_info;\n    let nodeContents = node[1].tag_contents;\n    this.context.state = STATES.HTML_BODY;\n    this.context.htmlBodiesIndexes.push(0);\n    let count = ++this.context.htmlBodiesCount;\n    this.fragments = `${this.fragments}      var el${count} = document.createElement(\"${nodeInfo.key}\");\\n`;\n    this.buildElementAttributes(nodeInfo.attributes);\n    this.walkContents(nodeContents);\n    this.context.htmlBodiesIndexes.pop();\n    this.context.htmlBodiesCount--;\n    this.fragments = `${this.fragments}      ${this.getElContainerName()}.appendChild(el${this.context.htmlBodiesCount+1});\\n`;\n  },\n  PLAIN_TEXT(node) {\n    if (this.context.state === STATES.HTML_ATTRIBUTE) {\n      return '\\'' + node[1] + '\\'';\n    } else if (this.context.state === STATES.HTML_BODY) {\n      this.fragments = `${this.fragments}      ${this.getElContainerName()}.appendChild(document.createTextNode('${node[1]}'));\\n`;\n    }\n  }\n};\n\nmodule.exports = compiler;\n"]}